generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Message {
  id         Int      @id @default(autoincrement())
  senderId   Int
  receiverId Int
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiver   User     @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
}

model ProfileComment {
  id        Int      @id @default(autoincrement())
  profileId Int      // The user whose profile is being commented on
  authorId  Int      // The user who wrote the comment
  content   String
  createdAt DateTime @default(now())
  profile   User     @relation("ProfileOwner", fields: [profileId], references: [id], onDelete: Cascade)
  author    User     @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
}

model User {
  id             Int                 @id @default(autoincrement())
  email          String              @unique
  password       String
  name           String?
  bio            String? // @db.Text not needed, standard string is fine for short bio
  role           String              @default("USER")
  theme          String              @default("default")
  status         String              @default("OFFLINE") // OFFLINE, ONLINE, AWAY, PLAYING
  statusMessage  String?             // e.g., "Playing Cyberpunk 2077"
  lastActive     DateTime            @default(now())
  walletBalance  Decimal             @default(0)
  loyaltyPoints  Int                 @default(0)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  activities     Activity[]
  devProjects    DevProject[]
  devComments    DevProjectComment[]
  followers      Follow[]            @relation("PublisherFollowers")
  following      Follow[]            @relation("UserFollowing")
  friendOf       Friend[]            @relation("UserFriendOf")
  friends        Friend[]            @relation("UserFriends")
  sentMessages   Message[]           @relation("MessageSender")
  receivedMessages Message[]         @relation("MessageReceiver")
  publishedGames Game[]              @relation("PublisherGames")
  library        Library[]
  notifications  Notification[]
  reviews        Review[]
  reviewVotes    ReviewVote[]
  giftsReceived  Transaction[]       @relation("GiftRecipient")
  transactions   Transaction[]
  wishlist       Wishlist[]
  cart           Cart[]
  voucherUsages  VoucherUsage[]
  forumPosts     ForumPost[]
  forumComments  ForumComment[]
  profileCommentsReceived ProfileComment[] @relation("ProfileOwner")
  profileCommentsWritten  ProfileComment[] @relation("CommentAuthor")
}

model ForumPost {
  id        Int            @id @default(autoincrement())
  userId    Int
  gameId    Int?           // Optional: link to a specific game community
  title     String
  content   String // @db.Text is implied in SQLite but good practice to be explicit for Postgres if we switch
  type      String         @default("DISCUSSION") // DISCUSSION, GUIDE, NEWS
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  game      Game?          @relation(fields: [gameId], references: [id], onDelete: SetNull)
  comments  ForumComment[]
}

model ForumComment {
  id        Int       @id @default(autoincrement())
  postId    Int
  userId    Int
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Game {
  id              Int           @id @default(autoincrement())
  title           String
  description     String // Should be Text in Postgres? For now let's keep String as Prisma default text is generous in SQLite.
  price           Decimal       @default(0)
  discount        Int           @default(0)
  imageUrl        String?
  releaseDate     DateTime      @default(now())
  publisherId     Int?
  isEarlyAccess   Boolean       @default(false)
  contentRating   String        @default("EVERYONE") // EVERYONE, TEEN, MATURE
  minRequirements String?       // JSON string
  recRequirements String?       // JSON string
  socialLinks     String?       // JSON string
  pointsAwarded   Int           @default(0)
  flashSaleEnd    DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  publisher       User?         @relation("PublisherGames", fields: [publisherId], references: [id], onDelete: SetNull)
  updates         GameUpdate[]
  inLibraries     Library[]
  reviews         Review[]
  inWishlists     Wishlist[]
  categories      Category[]    @relation("CategoryToGame")
  cartItems       Cart[]
  transactionItems TransactionItem[]
  screenshots     GameImage[]
  forumPosts      ForumPost[]
}

model GameImage {
  id        Int      @id @default(autoincrement())
  gameId    Int
  url       String
  createdAt DateTime @default(now())
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model DevProject {
  id          Int                 @id @default(autoincrement())
  publisherId Int
  title       String
  status      String              @default("CONCEPT")
  progress    Int                 @default(0)
  lastUpdate  DateTime            @default(now())
  createdAt   DateTime            @default(now())
  publisher   User                @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  comments    DevProjectComment[]
}

model Follow {
  id          Int      @id @default(autoincrement())
  userId      Int
  publisherId Int
  createdAt   DateTime @default(now())
  publisher   User     @relation("PublisherFollowers", fields: [publisherId], references: [id], onDelete: Cascade)
  user        User     @relation("UserFollowing", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, publisherId])
}

model Category {
  id    Int    @id @default(autoincrement())
  name  String @unique
  games Game[] @relation("CategoryToGame")
}

model TransactionItem {
  id            Int         @id @default(autoincrement())
  transactionId Int
  gameId        Int
  price         Decimal
  createdAt     DateTime    @default(now())
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  game          Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model Transaction {
  id          Int               @id @default(autoincrement())
  userId      Int
  recipientId Int?
  total       Decimal
  status      String            @default("PENDING")
  type        String            @default("PURCHASE")
  createdAt   DateTime          @default(now())
  recipient   User?             @relation("GiftRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       TransactionItem[]
}

model Library {
  id        Int      @id @default(autoincrement())
  userId    Int
  gameId    Int
  createdAt DateTime @default(now())
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
}

model Wishlist {
  id        Int      @id @default(autoincrement())
  userId    Int
  gameId    Int
  createdAt DateTime @default(now())
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
}

model Cart {
  id        Int      @id @default(autoincrement())
  userId    Int
  gameId    Int
  createdAt DateTime @default(now())
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
}

model Review {
  id        Int          @id @default(autoincrement())
  userId    Int
  gameId    Int
  rating    Int          @default(0)
  comment   String?
  createdAt DateTime     @default(now())
  game      Game         @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes     ReviewVote[]

  @@unique([userId, gameId])
}

model ReviewVote {
  id        Int      @id @default(autoincrement())
  reviewId  Int
  userId    Int
  isUpvote  Boolean
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
}

model DevProjectComment {
  id        Int        @id @default(autoincrement())
  projectId Int
  userId    Int
  content   String
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   DevProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model SaleEvent {
  id              Int      @id @default(autoincrement())
  name            String
  discountPercent Int      @default(0)
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  message   String
  type      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Friend {
  id        Int      @id @default(autoincrement())
  userId    Int
  friendId  Int
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  friend    User     @relation("UserFriendOf", fields: [friendId], references: [id], onDelete: Cascade)
  user      User     @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
}

model Activity {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String
  message   String
  metadata  String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model GameUpdate {
  id        Int      @id @default(autoincrement())
  gameId    Int
  title     String
  content   String
  version   String?
  type      String   @default("UPDATE")
  createdAt DateTime @default(now())
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model Voucher {
  id              Int            @id @default(autoincrement())
  code            String         @unique
  discountPercent Int
  maxUses         Int            @default(100)
  usedCount       Int            @default(0)
  expiryDate      DateTime
  isActive        Boolean        @default(true)
  publisherId     Int?           // Optional: link to a specific publisher
  createdAt       DateTime       @default(now())
  usages          VoucherUsage[]
}

model VoucherUsage {
  id        Int      @id @default(autoincrement())
  voucherId Int
  userId    Int
  usedAt    DateTime @default(now())
  voucher   Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([voucherId, userId])
}
